# Module 13.4: End-to-End (E2E) Testing with Cypress

**Objective:** To understand the purpose of End-to-End (E2E) testing and learn how to write and run E2E tests for an Angular application using Cypress, the recommended E2E testing tool.

---

### The Need for End-to-End Testing

While unit and integration tests verify individual pieces and their interactions, they don't guarantee that the entire application works correctly from a user's perspective. This is where **End-to-End (E2E) testing** comes in.

E2E tests simulate real user scenarios, interacting with the application through its user interface (UI) in a browser. They verify that all parts of the system—frontend, backend APIs, databases, and third-party integrations—work together as expected.

**Why E2E Testing is Crucial:**

*   **Confidence in User Flows:** Ensures critical user journeys (e.g., login, checkout, form submission) function correctly.
*   **Catch Integration Issues:** Uncovers bugs that might arise from the interaction of different components or services.
*   **Regression Prevention:** Acts as a safety net, preventing new code from breaking existing functionality.
*   **Business Assurance:** Directly validates that the application meets business requirements.

```mermaid
%%{init: {'theme':'neutral'}}%%
graph TD
    A[User Interaction (Simulated)] --> B{Browser};
    B --> C[Angular Frontend];
    C --> D[Backend API];
    D --> E[Database/External Services];
    E -- Response --> D;
    D -- Response --> C;
    C -- Renders UI --> B;
    B -- Assertions --> F[Test Runner (Cypress)];
```
**Alt text:** Diagram illustrating the End-to-End (E2E) testing flow. A simulated user interaction in the Browser interacts with the Angular Frontend, which communicates with the Backend API, which in turn interacts with a Database/External Services. Responses flow back, the Frontend renders the UI in the Browser, and a Test Runner (Cypress) performs assertions.

### Introducing Cypress

**Cypress** is a modern, fast, and developer-friendly E2E testing framework. It runs tests directly in the browser, providing a real-time view of the application as tests execute. It's the recommended E2E testing tool for new Angular CLI projects, replacing the older Protractor.

#### Advantages of Cypress:

*   **Developer Experience:** Excellent debugging capabilities, automatic reloads, and clear error messages.
*   **Speed:** Tests run very fast because Cypress executes in the same run loop as your application.
*   **Reliability:** Less flaky than traditional E2E tools due to its architecture.
*   **All-in-One:** Includes a test runner, assertion library, and mocking capabilities.
*   **Time Travel:** Allows you to see snapshots of your application at each step of the test.

--- 

### Setting Up Cypress in an Angular Project

If you generated your Angular project with a recent CLI version, Cypress might already be set up. If not, you can add it:

1.  **Install Cypress:**
    ```bash
    ng add @cypress/schematic
    ```
    This command will:
    *   Install Cypress and its dependencies.
    *   Add Cypress configuration files (`cypress.config.ts`, `cypress/support/e2e.ts`, etc.).
    *   Update `angular.json` with E2E build configurations.
    *   Add a sample E2E test.

2.  **Open Cypress Test Runner:**
    ```bash
    ng e2e
    ```
    This command will:
    *   Build your Angular application.
    *   Launch the Cypress Test Runner UI.

    From the Cypress UI, you can choose to run E2E tests in a browser. Cypress will open a new browser window where your application will run, and your tests will execute.

### Writing Your First Cypress Test

Cypress tests are written in JavaScript or TypeScript and use a syntax similar to Jasmine or Jest (`describe`, `it`, `expect`). Cypress provides a global `cy` object for interacting with the browser and your application.

#### Basic Interactions and Assertions

**Example: Testing a Login Page**

Assume you have a simple login page with username, password fields, and a login button.

```html
<!-- src/app/login/login.component.html -->
<form>
  <label for="username">Username:</label>
  <input id="username" type="text" name="username">

  <label for="password">Password:</label>
  <input id="password" type="password" name="password">

  <button type="submit">Login</button>
</form>
<p class="error-message"></p>
```

**Test File (`cypress/e2e/login.cy.ts`):**

```typescript
// Describe a test suite for the login page
describe('Login Page', () => {
  // Before each test, visit the login page
  beforeEach(() => {
    cy.visit('/login'); // Assuming your Angular app runs on /login route
  });

  it('should display login form', () => {
    // Assert that elements exist on the page
    cy.get('#username').should('be.visible');
    cy.get('#password').should('be.visible');
    cy.get('button').contains('Login').should('be.visible');
  });

  it('should allow a user to log in successfully', () => {
    // Type into the username and password fields
    cy.get('#username').type('testuser');
    cy.get('#password').type('password123');

    // Click the login button
    cy.get('button').contains('Login').click();

    // Assert that the user is redirected to the dashboard (or a success page)
    cy.url().should('include', '/dashboard');
    cy.contains('Welcome, testuser!').should('be.visible');
  });

  it('should show an error for invalid credentials', () => {
    // Simulate invalid login
    cy.get('#username').type('wronguser');
    cy.get('#password').type('wrongpass');
    cy.get('button').contains('Login').click();

    // Assert that an error message is displayed
    cy.get('.error-message').should('contain', 'Invalid credentials');
    cy.url().should('include', '/login'); // Should remain on login page
  });
});
```

**Key Cypress Commands:**

*   **`cy.visit(url)`:** Navigates the browser to a specific URL.
*   **`cy.get(selector)`:** Queries for DOM elements using CSS selectors. Returns a Cypress Chainable object.
*   **`.should(assertion, value)`:** Makes assertions about the state of the DOM element (e.g., `should('be.visible')`, `should('contain', 'text')`).
*   **`.type(text)`:** Types text into an input field.
*   **`.click()`:** Clicks on an element.
*   **`cy.url()`:** Gets the current URL.
*   **`cy.contains(text)`:** Finds an element containing specific text.

### Advanced Cypress Features

*   **Fixtures:** Use static JSON files (`cypress/fixtures/`) to mock API responses, ensuring consistent test data.
*   **Custom Commands:** Create reusable functions for common test actions (e.g., `cy.login()`).
*   **Network Stubbing:** Intercept and control HTTP requests and responses using `cy.intercept()`, allowing you to test various API scenarios (success, error, loading states) without hitting a real backend.

```typescript
// Example of network stubbing
it('should display loading state then products', () => {
  cy.intercept('GET', '/api/products', {
    delay: 1000, // Simulate network delay
    fixture: 'products.json' // Serve data from a fixture file
  }).as('getProducts');

  cy.visit('/products');
  cy.get('.loading-spinner').should('be.visible');
  cy.wait('@getProducts'); // Wait for the intercepted request to complete
  cy.get('.product-list').should('be.visible');
});
```

*   **Component Testing (Experimental):** Cypress is also developing capabilities for component testing, allowing you to mount and test Angular components in isolation within the Cypress browser environment.

E2E testing with Cypress provides a high level of confidence that your Angular application works correctly from the user's perspective. It's an indispensable tool for ensuring the quality and reliability of your web applications.

---

### Hands-on Exercise: Write a Cypress E2E Test for a Simple Form

1.  **Ensure Cypress is set up** in your project (if not, run `ng add @cypress/schematic`).
2.  **Create a simple Angular component** (e.g., `ContactFormComponent`) with:
    *   An input field for `name`.
    *   An input field for `email`.
    *   A `textarea` for `message`.
    *   A submit button.
    *   A paragraph or div to display a success message after submission.
3.  **Add basic validation** (e.g., `required`) to the input fields.
4.  **Create a new Cypress test file** (e.g., `cypress/e2e/contact-form.cy.ts`).
5.  **Write an E2E test that:**
    *   Visits the page where your `ContactFormComponent` is rendered.
    *   Asserts that the form elements are visible.
    *   Types valid data into the `name`, `email`, and `message` fields.
    *   Clicks the submit button.
    *   Asserts that a success message is displayed on the page.
6.  **(Optional) Add a test case for invalid submission:**
    *   Leave a required field empty.
    *   Click submit.
    *   Assert that an error message is displayed and the success message is NOT displayed.
7.  **Run your Cypress tests** using `ng e2e` and observe the test execution.

---

**End of Module 13.**

**Previous:** [13.3 Unit Testing Services and Pipes](./13.3-unit-testing-services-pipes.md)

**Next:** [14-build-and-deployment](../14-build-and-deployment)
